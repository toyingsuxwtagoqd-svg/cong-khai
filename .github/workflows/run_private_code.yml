name: Run Private Code (YouTube)

on:
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: run-private-code
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      # 1) Lấy repo riêng tư về thư mục private-src/
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.PRIVATE_REPO_REPOSITORY }}   # ví dụ: nguoi-viet/cong-khai-private
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}             # token phải có quyền read (và càng tốt là write)
          ref: main
          path: private-src
          fetch-depth: 1
          persist-credentials: false

      # 2) Nếu trong repo riêng tư đã có tieudedalay.csv thì đẩy nó ra ngoài
      #    vì main.py đang ghi ở mức ../tieudedalay.csv
      - name: Pre-sync tieudedalay.csv (private-src -> workspace)
        run: |
          if [ -f "private-src/tieudedalay.csv" ]; then
            cp private-src/tieudedalay.csv ./tieudedalay.csv
          fi

      # 3) Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # 4) Gói hệ thống
      - name: Install system packages
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libsndfile1 fonts-dejavu-core

      # 5) Python deps (đúng như bạn đang xài)
      - name: Install Python deps
        working-directory: private-src
        run: |
          python -m pip install --upgrade pip
          pip install --index-url https://download.pytorch.org/whl/cpu "torch==2.4.*" "torchaudio==2.4.*"
          pip install "TTS==0.22.0" "transformers==4.44.2" "huggingface_hub<0.34" pillow soundfile numpy requests tqdm underthesea vinorm google-genai
          pip install "google-api-python-client" "google-auth" "google-auth-oauthlib"

      # 6) Chạy main.py trong repo riêng tư — cần 4 secrets bắt buộc ở repo công khai
      - name: Run main.py (video + thumb + append tieudedalay.csv)
        working-directory: private-src
        env:
          # --- bắt buộc để ở repo công khai ---
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          YT_CLIENT_ID: ${{ secrets.YT_CLIENT_ID }}
          YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
          YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}

          # --- phần còn lại: chỉ là cấu hình, không bí mật ---
          TARGET_AUDIO_SEC: "600"
          INIT_TARGET_CHARS: "5000"
          INIT_TARGET_SEC_HINT: "300"

          TOP_K: "1"
          TOP_P: "0.30"
          R_PEN: "12.0"
          L_PEN: "1.05"
          CHUNK_MAX_CHARS: "200"
          SENTENCE_PAUSE_MS: "0"

          IMG_W: "1280"
          IMG_H: "720"
          POLL_IMG_MODEL: "flux-anime"
          IMG_RATE_SEC: "1.5"
          IMG_TIMEOUT_SEC: "15"

          YOUTUBE_PRIVACY: public
          PYTHONUNBUFFERED: "1"
        run: |
          set -Eeuo pipefail
          if [ -f "src/main.py" ]; then
            python src/main.py
          else
            python main.py
          fi

      # 7) Sau khi chạy xong: main.py đã ghi ../tieudedalay.csv → kéo lại về private-src để commit
      - name: Post-sync tieudedalay.csv (workspace -> private-src)
        run: |
          if [ -f "tieudedalay.csv" ]; then
            cp tieudedalay.csv private-src/tieudedalay.csv
          fi

      # 8) Commit & push về repo riêng tư nếu token có quyền ghi
      - name: Commit & push tieudedalay.csv back to PRIVATE
        working-directory: private-src
        env:
          TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
          REPO: ${{ secrets.PRIVATE_REPO_REPOSITORY }}
        run: |
          set -e
          # nếu token chỉ read → bỏ qua nhẹ nhàng
          if [ -z "$TOKEN" ]; then
            echo "[INFO] Không có PRIVATE_REPO_TOKEN → bỏ qua push."
            exit 0
          fi

          if [ ! -f "tieudedalay.csv" ]; then
            echo "[INFO] Không có tieudedalay.csv để commit."
            exit 0
          fi

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${TOKEN}@github.com/${REPO}.git"

          git add tieudedalay.csv
          git diff --cached --quiet && { echo "[INFO] Không có thay đổi."; exit 0; }
          git commit -m "ci(state): update tieudedalay.csv"
          git push origin HEAD:main
